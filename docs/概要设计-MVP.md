Life Coach（对话记录助手）MVP阶段概要设计文档（树莓派部署版）

一、文档概述

1.1 文档目的

本文档基于Life Coach MVP阶段PRD，结合树莓派硬件特性（ARM架构、有限资源、GPIO扩展），明确适配树莓派的技术架构、模块划分、硬件适配、技术选型及核心流程，为开发团队提供树莓派端技术落地蓝图，确保软件与树莓派扩展录音模块、控制按钮协同工作，兼顾轻量运行、数据隐私安全与核心功能落地。

1.2 核心约束

- 隐私优先：所有对话数据、音频文件默认存储于树莓派本地（SD卡/外接存储），无强制云端上传，本地文件加密保护，适配树莓派存储特性。

- 轻量适配：适配树莓派4B/5（最低配置：CPU 4核ARM Cortex-A72、内存2GB+），启动速度≤5秒，AI处理延迟≤15秒（1500字内对话，适配树莓派算力）。

- 硬件协同：支持树莓派扩展录音模块（USB/I2S接口）、GPIO按钮控制（录音启停、AI处理触发），兼容树莓派GPIO引脚定义与硬件驱动。

- 系统兼容：支持Raspbian OS 12（Bookworm），适配ARM64架构，依赖库优先选择树莓派原生支持版本，降低部署复杂度。

1.3 术语定义

术语

定义

本地ASR

适配树莓派的轻量本地语音识别，基于Whisper Tiny量化版/FunASR轻量模型实现离线转写，适配ARM架构算力。

AI结构化处理

通过树莓派可运行的轻量化本地LLM，对原始对话进行整理、关键词提取、总结与待办生成，采用INT4量化优化算力占用。

GPIO按钮控制

通过树莓派GPIO引脚连接物理按钮，实现录音启停、AI处理触发等操作，含防抖与状态反馈逻辑。

扩展录音模块

适配树莓派的外接录音设备（USB声卡+麦克风/I2S数字麦克风模块），通过驱动适配实现音频采集。

流式识别

基于扩展录音模块实时收音，同步转写文字，延迟≤1.5秒/句话，适配树莓派算力与录音模块采样率。

二、整体架构设计

2.1 架构分层

针对树莓派资源约束，采用轻量化分层架构，精简冗余模块，新增硬件适配层，确保职责边界清晰、低耗运行，自上而下分为5层：

1. 表现层（Presentation Layer）：简化设计，支持命令行交互（核心）+ 轻量本地Web界面（可选），适配树莓派显示输出。

2. 业务逻辑层（Business Logic Layer）：封装核心业务流程，协调硬件控制、语音转写、AI处理模块协同工作，精简算力占用。

3. 硬件适配层（Hardware Adaptation Layer）：新增层，负责树莓派GPIO引脚驱动、扩展录音模块适配、按钮控制逻辑，隔离硬件差异。

4. 核心服务层（Core Service Layer）：采用轻量模型与工具库，提供适配树莓派的语音识别、AI处理、数据加密等核心能力。

5. 数据持久层（Data Persistence Layer）：适配树莓派存储（SD卡/外接U盘），负责本地数据存储、备份与检索，优化存储IO效率。

6. 公共组件（Common Components）：跨层复用轻量能力，如日志、异常处理、资源监控（适配树莓派CPU/内存/存储占用）。

2.2 架构图

暂时无法在豆包文档外展示此内容
三、模块详细设计

3.1 表现层设计

3.1.1 技术选型

适配树莓派轻量运行需求，采用“命令行优先+Web界面可选”方案，规避重框架资源占用：

- 命令行交互：Python Click库（轻量、易扩展），支持快捷键与按钮联动操作。

- 可选Web界面：Flask（轻量Python Web框架），页面极简设计，仅提供核心操作入口，适配树莓派内网访问。

- 状态反馈：通过命令行打印、LED指示灯（连接GPIO）反馈录音状态、AI处理进度，无需依赖复杂显示设备。

3.1.2 核心交互组件

1. 命令行交互组件：
        

  - 核心指令：支持录音启停（与GPIO按钮联动）、AI处理触发、对话查询/导出、基础配置修改。

  - 状态显示：实时打印录音时长、转写进度、AI处理状态、存储占用情况，关键信息高亮提示。

2. 轻量Web界面组件（可选）：
        

  - 核心页面：对话列表、对话详情、基础设置，页面资源压缩，加载速度≤2秒。

  - 交互逻辑：支持鼠标点击操作，与命令行、GPIO按钮状态同步（如按钮启动录音后，Web界面实时更新状态）。

3. LED状态反馈组件：
        

  - 通过GPIO连接2个LED灯：红灯表示录音中，绿灯表示AI处理中/操作完成，异常时红灯闪烁。

3.2 硬件适配层设计（新增）

3.2.1 技术选型

- GPIO控制：RPi.GPIO库（树莓派原生支持，轻量无依赖），适配GPIO引脚定义（树莓派4B/5通用）。

- 录音模块适配：USB声卡+麦克风（优先，驱动免额外安装）/I2S麦克风模块（如Adafruit I2S MEMS Mic，需配置设备树）。

- 音频采集：PyAudio（轻量音频采集库，适配树莓派音频接口）、alsa-utils（系统级音频驱动工具，辅助调试）。

3.2.2 核心模块

1. GPIO按钮控制服务：
        

  - 引脚分配：选用GPIO2（按钮1，录音启停）、GPIO3（按钮2，AI处理触发），支持引脚自定义配置。

  - 核心逻辑：按钮按下防抖处理（软件延时去抖，延时20ms），短按触发对应操作，长按（≥3秒）取消操作，与命令行操作互斥避免冲突。

  - 状态联动：按钮操作后同步更新表现层状态（命令行提示、LED指示灯），确保操作可视化。

2. 扩展录音模块适配服务：
        

  - USB录音模块：自动识别USB声卡设备，配置采样率为16kHz（ASR模型最优输入），声道为单声道（精简数据量）。

  - I2S录音模块：配置树莓派设备树，启用I2S接口，加载对应驱动，设置采样率与USB模块一致，确保音频数据兼容性。

  - 音频采集优化：设置缓冲区大小为1024字节，平衡采集延迟与树莓派CPU占用，避免卡顿。

3. 硬件状态监控服务：
        

  - 实时监控录音模块连接状态、按钮电平状态，异常时（如录音模块断开）触发提示（命令行+LED闪烁）。

  - 资源联动：当树莓派CPU占用≥80%或内存占用≥70%时，暂停非核心硬件操作（如AI处理），优先保障录音稳定性。

3.3 业务逻辑层设计

3.3.1 对话录入模块（适配硬件控制）

- 核心职责：协调GPIO按钮、扩展录音模块与ASR服务，处理对话保存与角色归属逻辑，适配树莓派算力调度。

- 关键流程：
        

  1. 按钮触发录音：按下GPIO2按钮 → 硬件适配层反馈状态 → 启动录音模块采集音频 → 调用轻量ASR服务流式转写 → 生成临时对话内容（带时间戳）。

  2. 停止录音：再次按下GPIO2按钮 → 停止音频采集与转写 → 提示用户确认角色归属（命令行输入） → 保存至数据库。

  3. 手动输入（备用）：命令行输入对话内容 → 选择角色 → 自动添加时间戳 → 保存至数据库，适配录音模块故障场景。

- 状态管理：维护当前录音状态（未开始/录制中/已停止）、转写进度，异常中断时保留已采集音频与转写内容，避免数据丢失。

3.3.2 AI智能处理模块（树莓派轻量化适配）

- 核心职责：调用树莓派可运行的量化版本地LLM，完成对话结构化整理、关键词提取、总结与待办生成，控制算力占用。

- 关键流程：
        

  1. 触发AI处理：按下GPIO3按钮（需录音已停止），或命令行输入指令触发，LED绿灯亮起表示处理中。

  2. 数据预处理：获取当前对话原始内容 → 过滤冗余信息、压缩文本长度（适配LLM输入限制） → 按角色格式化输入。

  3. 调用AI服务：传递格式化内容与精简版任务指令 → 量化LLM异步处理（避免阻塞主线程） → 接收返回结果。

  4. 结果处理：解析AI返回数据 → 按简化格式（主题-要点-待办）渲染 → 命令行打印/Web界面显示，绿灯熄灭表示处理完成。

- 容错处理：AI处理失败时（如内存不足），提示用户释放资源（关闭非核心进程），保留原始对话，支持重试。

3.3.3 对话管理模块（精简版）

- 核心职责：精简功能，负责对话的基础检索、编辑、导出，适配树莓派存储与算力。

- 关键功能：
        

  1. 检索功能：关键词检索（匹配对话内容、标题），命令行返回匹配结果，支持按时间倒序排列。

  2. 基础编辑：命令行修改对话内容/角色归属，自动更新时间戳，保留最近1个历史版本（精简存储占用）。

  3. 导出功能：支持导出TXT格式，保存至树莓派本地路径或外接U盘，适配树莓派文件系统。

3.4 核心服务层设计（树莓派轻量化适配）

3.4.1 轻量本地ASR服务

- 技术选型：集成Whisper Tiny INT4量化版（适配ARM架构，内存占用≤300MB），封装为Python服务，依赖PyTorch ARM版。

- 核心能力：
        

  1. 流式识别：适配扩展录音模块采集的音频流，每句话延迟≤1.5秒，返回分段文字，CPU占用控制在60%以内。

  2. 批量转写：支持本地音频文件（WAV格式）转写，速度≥1倍音频时长，适配树莓派SD卡读取速度。

  3. 模型优化：预加载模型至内存（启动时加载，占用≤300MB），避免重复加载消耗算力，支持模型按需卸载（内存紧张时）。

- 接口设计：提供本地函数调用接口（规避网络开销），支持启动/暂停/停止转写，返回转写进度与结果。

3.4.2 量化版AI处理服务

- 技术选型：集成Phi-2 INT4量化版（ARM架构适配，内存占用≤500MB），通过llama.cpp部署，精简计算链路。

- 核心能力：
        

  1. 结构化整理：通过精简Prompt引导模型输出“主题-要点-待办”格式数据，单条对话处理字数≤1500字。

  2. 关键词/要点提取：提取3-5个核心关键词，生成≤15字/条的要点清单，减少模型计算量。

  3. 总结生成：生成50-150字精简总结，无多余冗余内容，单条对话处理时间≤15秒，CPU占用控制在70%以内。

- 性能优化：启用CPU多核并行计算（树莓派4核全用），关闭模型冗余功能，处理完成后释放部分内存，保障系统稳定性。

3.4.3 轻量音频处理服务

- 技术选型：集成FFmpeg轻量版（树莓派原生apt安装，精简编译选项），封装音频格式转换、采样率调整功能。

- 核心能力：
       

  1. 格式转换：将录音模块采集的音频转为16kHz、单声道WAV格式（ASR模型最优输入），精简数据量。

  2. 采样率统一：强制音频采样率为16kHz，避免格式不兼容导致的转写失败，降低处理复杂度。

  3. 降噪简化：仅保留基础降噪（去除明显环境噪音），规避复杂算法占用过多算力，适配树莓派性能。

3.5 数据持久层设计（适配树莓派存储）

3.5.1 技术选型

- 本地数据库：SQLite 3（轻量、无需单独部署，适配树莓派SD卡IO，数据库文件大小控制≤1GB）。

- 文件存储：默认存储于树莓派SD卡（路径：/home/pi/LifeCoach/），支持外接U盘扩展存储（自动识别挂载路径）。

- 检索优化：基于SQLite索引，仅为title、content字段建立简易索引，避免索引占用过多SD卡空间。

3.5.2 存储与备份策略

- 存储优化：音频文件采用WAV压缩格式，对话数据按日期分文件夹存储，减少SD卡碎片整理开销。

- 自动备份：每日凌晨3点（树莓派低负载时段）执行备份，备份文件存储至外接U盘（优先）/SD卡备用分区，保留最近2次备份（精简存储）。

- 手动备份：命令行输入备份指令，触发即时备份，生成带时间戳的备份文件，适配SD卡容量有限特性。

3.6 公共组件设计（树莓派适配）

1. 轻量日志组件：采用Python logging模块（无额外依赖），日志文件按天分割，单文件大小≤100MB，保留7天日志，避免占用过多SD卡空间。

2. 异常处理组件：统一捕获硬件操作、模型运行、存储IO异常，提供命令行提示+LED闪烁报警（红灯闪烁），记录简化异常栈信息。

3. 资源监控组件：实时监控树莓派CPU、内存、SD卡占用，占用超标时（CPU≥80%/内存≥70%/存储≥85%）触发提示，暂停非核心操作。

四、接口设计

4.1 内部接口（模块间调用）

采用本地函数调用方式（规避网络开销，适配树莓派轻量运行），模块间通过Python函数直接交互，定义清晰参数与返回值：

函数名

参数

返回结果

所属模块

audio_record.start()

sample_rate=16000, channel=1

status（成功/失败）、record_id（录音ID）

扩展录音模块适配服务

asr.transcribe_stream()

audio_stream（音频流）、model_type="tiny-int4"

status、transcript（分段转写文字）、progress（进度）

轻量本地ASR服务

ai.process_text()

content（对话内容）、task_type（整理/提取/总结）

status、result（结构化结果/关键词/总结）

量化版AI处理服务

gpio_button.listen()

pin（引脚号）、callback（回调函数）

status（监听启动成功/失败）

GPIO按钮控制服务

4.2 外部依赖接口

MVP阶段无强制外部接口依赖，所有核心能力本地实现；可选依赖接口（用于模型下载与系统更新）：

- 模型下载接口：首次启动时从树莓派适配的模型源（如Hugging Face ARM镜像）下载量化版ASR/AI模型，本地缓存后无需重复下载。

- 系统更新接口：定期检查依赖库（如PyTorch、llama.cpp）的树莓派适配版本，提示用户手动更新（无强制更新）。

五、非功能需求落地设计（树莓派适配）

5.1 性能优化设计

1. 启动速度：模型按需加载（ASR模型启动时加载，AI模型处理时加载），精简启动项，启动时间≤5秒。

2. 运行性能：单任务并行（录音与转写并行，AI处理单独执行），CPU占用峰值≤80%，内存占用≤800MB（适配2GB内存树莓派）。

3. 存储优化：日志、备份文件定期清理，音频文件压缩存储，SD卡占用增长率≤500MB/天（按每日1小时录音计算）。

5.2 硬件适配与稳定性设计

1. 硬件兼容性：优先适配USB录音模块（驱动通用性强），I2S模块提供设备树配置模板，支持主流树莓派扩展板。

2. 按钮防抖：软件延时去抖+硬件上拉电阻（可选），避免按钮误触发，提升操作稳定性。

3. 断电保护：录音过程中检测到断电风险（如电压过低），立即保存已采集音频与转写内容，避免数据丢失。

5.3 隐私安全设计

1. 数据加密：采用AES-128加密算法（适配树莓派算力，降低加密开销），密钥基于树莓派硬件唯一标识生成，本地存储不联网。

2. 存储安全：SD卡分区加密（可选，通过cryptsetup实现），防止SD卡被盗取导致数据泄露。

六、部署与交付设计（树莓派专属）

6.1 部署方案

- 系统要求：Raspbian OS 12（Bookworm）ARM64版，树莓派4B/5（内存≥2GB，建议4GB），SD卡≥16GB（Class 10）。

- 部署方式：Shell脚本自动化部署，一键安装依赖库（Python 3.11+、PyTorch ARM版、FFmpeg等）、下载量化模型、配置GPIO引脚。

- 启动方式：设置为树莓派开机自启服务（通过systemd配置），支持命令行启停，异常崩溃后自动重启。

- 硬件部署：
        

  1. 录音模块：USB声卡插入树莓派USB口，麦克风连接声卡；I2S模块按引脚定义连接树莓派GPIO。

  2. 按钮与LED：GPIO2（录音按钮）、GPIO3（AI处理按钮）、GPIO17（红灯，录音中）、GPIO18（绿灯，AI处理中），对应引脚接按钮与LED（串联220Ω电阻）。

6.2 交付物

1. 自动化部署脚本（deploy.sh）、服务启停脚本（start.sh/stop.sh）。

2. 量化模型包（Whisper Tiny INT4、Phi-2 INT4，适配ARM架构）。

3. 数据库初始化脚本（SQLite）、GPIO配置模板。

4. 部署手册（含硬件接线图、脚本使用说明、常见问题排查）。

5. 测试报告（树莓派端功能测试、性能测试、硬件兼容性测试结果）。

七、迭代扩展预留设计

7.1 接口预留

- 预留蓝牙适配接口：支持后续添加蓝牙麦克风、蓝牙按钮，替代有线硬件连接。

- 预留远程管理接口：轻量MQTT接口，支持通过手机APP远程查看状态（无数据上传，仅内网访问）。

7.2 模块预留

- AI模块预留模型切换接口：支持后续集成更小体积的量化模型（如GPT-2 INT4），适配更低配置树莓派。

- 硬件适配层预留传感器接口：支持后续添加声音传感器，实现声音触发录音（替代手动按钮）。

八、风险与应对措施

风险类型

风险描述

应对措施

硬件风险

扩展录音模块兼容性差、GPIO引脚冲突

优先推荐经过测试的USB录音模块，提供GPIO引脚自定义配置选项，避开树莓派默认占用引脚。

性能风险

树莓派内存不足导致AI模型运行崩溃

采用INT4量化模型，运行时释放非核心内存，内存占用超标时自动终止AI处理，保留录音功能。

稳定性风险

长时间运行导致SD卡IO错误、CPU过热

定期清理SD卡缓存，开启树莓派CPU温控保护，建议外接散热片，重要数据备份至U盘。

部署风险

依赖库安装失败、模型下载缓慢

提供离线依赖包与模型包，部署脚本支持离线安装，优化国内镜像源加速下载。
