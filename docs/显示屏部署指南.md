# Life Coach 显示屏部署指南

## 硬件要求

### OLED-LCD-HAT-A 扩展板规格
- **主屏**: 2英寸 IPS LCD (240×320), ST7789驱动, SPI接口
- **副屏1**: 0.96英寸 OLED (128×64), SSD1306驱动, I2C地址 0x3C
- **副屏2**: 0.96英寸 OLED (128×64), SSD1306驱动, I2C地址 0x3D

### 引脚映射
| 功能 | 引脚 | 物理引脚号 |
|------|------|-----------|
| VCC  | 3.3V | - |
| GND  | GND  | - |
| LCD MOSI | GPIO10 | 19 |
| LCD SCLK | GPIO11 | 23 |
| LCD CS   | GPIO8  | 24 |
| LCD DC   | GPIO22 | 15 |
| LCD RST  | GPIO27 | 13 |
| OLED SDA | GPIO2  | 3 |
| OLED SCL | GPIO3  | 5 |

## 软件依赖安装

### 1. 启用I2C和SPI接口
```bash
# 进入配置界面
sudo raspi-config

# 选择 Interfacing Options → SPI → Yes
# 选择 Interfacing Options → I2C → Yes

# 重启生效
sudo reboot
```

### 2. 安装Python依赖库
```bash
# 更新包管理器
sudo apt-get update

# 安装luma显示库（核心依赖）
sudo apt-get install -y luma.oled luma.lcd

# 或使用pip安装
pip3 install luma.oled luma.lcd

# 安装PIL图像库（如未安装）
sudo apt-get install python3-pil

# 安装中文字体
sudo apt-get install -y fonts-wqy-microhei
```

### 3. 验证硬件连接
```bash
# 检测I2C设备（应看到0x3c和0x3d）
i2cdetect -y 1

# 检测SPI设备
ls /dev/spidev*
```

预期输出：
```
# i2cdetect -y 1
     0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f
00:          -- -- -- -- -- -- -- -- -- -- -- -- --
10: -- -- -- -- -- -- -- -- -- -- -- -- 3c -- -- --
20: -- -- -- -- -- -- -- -- -- -- -- -- -- 3d -- --
...

# ls /dev/spidev*
/dev/spidev0.0  /dev/spidev0.1
```

## 测试显示功能

### 独立测试显示控制器
```bash
cd ~/LifeCoach
python3 src/display_controller.py
```

预期输出：
```
正在初始化OLED状态屏 (0x3C)...
✓ OLED状态屏初始化成功
正在初始化OLED统计屏 (0x3D)...
✓ OLED统计屏初始化成功
正在初始化LCD主屏 (SPI)...
✓ LCD主屏初始化成功
✓ 字体加载成功: 6 种字体

测试状态屏...
测试统计屏...
测试转录文本...
✓ 所有测试完成
```

### 集成测试（完整系统）
```bash
# 确保服务已停止
sudo systemctl stop lifecoach

# 启用显示功能
export DISPLAY_ENABLED=true

# 启动服务
cd ~/LifeCoach
python3 main.py
```

观察屏幕：
- **OLED #1**: 应显示 "Life Coach" 欢迎界面
- **OLED #2**: 应显示版本和时间
- **LCD主屏**: 应显示 "按K1开始录音" 提示

## 配置说明

### 环境变量配置
在 `~/.bashrc` 或部署脚本中设置：
```bash
# 启用显示功能
export DISPLAY_ENABLED=true

# 其他显示配置（可选）
export LCD_ROTATE=0  # 屏幕旋转角度：0/1/2/3
```

### config.py 配置项
```python
# 显示功能开关
DISPLAY_ENABLED = True  # 树莓派默认启用

# OLED配置
OLED_STATUS_ADDRESS = 0x3C  # 状态屏I2C地址
OLED_STATS_ADDRESS = 0x3D   # 统计屏I2C地址

# LCD配置
LCD_WIDTH = 240
LCD_HEIGHT = 320
LCD_ROTATE = 0              # 旋转角度
LCD_MAX_TRANSCRIPT_LINES = 10  # 最多显示行数
```

## 功能说明

### OLED #1 - 状态屏 (0x3C)
显示内容：
- 系统状态（待机/录音中/转录中）
- 录音时长（MM:SS格式）
- 当前字数
- 当前时间

### OLED #2 - 统计屏 (0x3D)
显示内容：
- 今日录音次数
- 总录音时长
- 总字数
- CPU使用率
- 内存使用率

### LCD主屏 - 转录文本 (SPI)
显示内容：
- 实时转录文本（滚动显示）
- 最多显示10行文本
- 每行约12个汉字
- 自动换行

## 故障排查

### 问题1: luma库导入失败
```
ImportError: No module named 'luma'
```

**解决方法**:
```bash
# 确认Python版本
python3 --version

# 重新安装luma库
pip3 install --upgrade luma.oled luma.lcd
```

### 问题2: I2C设备未检测到
```
i2cdetect: command not found
或检测不到0x3c/0x3d
```

**解决方法**:
```bash
# 安装i2c-tools
sudo apt-get install i2c-tools

# 检查I2C是否启用
sudo raspi-config
# Interfacing Options → I2C → Yes

# 检查/dev/i2c-1是否存在
ls -l /dev/i2c*

# 检查内核模块
lsmod | grep i2c
```

### 问题3: SPI设备未检测到
```
FileNotFoundError: /dev/spidev0.0
```

**解决方法**:
```bash
# 启用SPI
sudo raspi-config
# Interfacing Options → SPI → Yes

# 检查SPI设备
ls -l /dev/spidev*

# 检查内核模块
lsmod | grep spi
```

### 问题4: 屏幕显示异常/黑屏
**原因**: 引脚连接错误或电源不足

**解决方法**:
```bash
# 1. 检查引脚连接是否正确
# 2. 确认扩展板供电充足（USB供电≥2.5A）
# 3. 运行测试程序
python3 src/display_controller.py

# 4. 检查日志
sudo journalctl -u lifecoach -f | grep -i display
```

### 问题5: 中文字体显示为方框
**原因**: 缺少中文字体

**解决方法**:
```bash
# 安装文泉驿微米黑字体
sudo apt-get install -y fonts-wqy-microhei

# 刷新字体缓存
fc-cache -fv

# 验证字体安装
fc-list | grep -i wqy
```

### 问题6: 显示功能禁用
日志输出：
```
警告: luma显示库未安装，显示功能将被禁用
显示功能已禁用
```

**解决方法**:
```bash
# 检查配置
echo $DISPLAY_ENABLED

# 启用显示
export DISPLAY_ENABLED=true

# 或在config.py中修改
DISPLAY_ENABLED = True
```

## 性能优化

### 减少屏幕刷新频率
在 `config.py` 中调整：
```python
OLED_REFRESH_IDLE = 5.0      # 待机刷新间隔（秒）
OLED_REFRESH_RECORDING = 1.0  # 录音中刷新间隔
```

### 降低LCD文本行数
```python
LCD_MAX_TRANSCRIPT_LINES = 5  # 减少到5行
```

## 参考资料

- [硬件文档](https://spotpear.cn/wiki/0.96inch-OLED-2inch-LCD-HAT-A.html)
- [luma.oled 文档](https://luma-oled.readthedocs.io/)
- [luma.lcd 文档](https://luma-lcd.readthedocs.io/)
- [树莓派GPIO引脚图](https://pinout.xyz/)
